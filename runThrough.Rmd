---
title: "flgaCBC"
author: "Burnett, JL"
date: "February 20, 2019"
output: pdf_document
---
```{r JESSICANOTES, eval=F}
## SPECIES TO INCLUDE
# You can count hummingbird sp, Archilochus sp., waterthrush sp., Empidonax sp. as Neotropical migrants,   Crow sp. as urban adapters, accipiter sp. as feeder adapters. I'd say ignore the rest.   

```

```{r libs, include=F}
# Install packages as necessary
list.of.packages <- c(
    "stringr","ggplot2",  "here",  "knitr", "tidyr", "reshape2", "readr", "dplyr", "devtools", "kableExtra")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

# Load pkgs
lapply(list.of.packages, require, character.only = TRUE)

# Install git packages 
devtools::install_github("trashbirdecology/flgaCBC", force = F)
library(flgaCBC)
```

```{r setup, include=FALSE}
# Set default chunk options
knitr::opts_chunk$set( include = F, fig.cap = "...", cache = T)
# Define directories and create as necessary
dataDir <- paste0(here::here(), "/data/")
```

```{r importMungeData}
## Import and munge Christmas Bird Count data & NACC species list
# Load CBC data (YYYY - 2015)
birds_1957to2015 <-
  read.csv(paste0(dataDir,"CBC_flga_1957to2015.csv"), stringsAsFactors = FALSE, check.names = F) %>% 
    gather(key = "key", value = "value", -(1:4), factor_key =T) %>% 
    filter(!value %in% c("CW", "cw")) %>% 
    mutate(value = as.integer(value))

# Load recent data (2016-2018)
birds2016_2018 <-  read.csv(paste0(dataDir,"CBC_flga_2016to2018_long.csv"), stringsAsFactors = FALSE, check.names = F) %>% 
    rename( key = species, 
            value = how_many)

# Merge orig data sets
birds <- full_join(birds_1957to2015, birds2016_2018) %>% 
    editNames() 

# Get NACC checklist (aou)
if(!exists("nacc")){nacc <- getNACC(remove.hypen = F)}


# See which species are in birds but not in nacc.list
(missingSpp<-setdiff(unique(birds$key), nacc$key) %>% sort())
  ## If there are issues, I recommend fixing them in the function editNames.R, or just do it in this chunk..
        # Un resolved issues, if necessary
        # NACC does not contain the following species that occur in CBC data:
            # Gray-headed swamphen (Porphyrio poliocephalus)

# join NACC list with our CBC data
birds <- left_join(birds, nacc) 

# Get total species count (excludes groups (like Sp., or UNID))
birds <- estRichness(birds, missingSpp, ignore = missingSpp[c(9)] ) %>% 
    right_join(birds)

# Clear some temp objects
rm(nacc, birds_1957to2015, birds2016_2018)

startYear <- 1972
```

## FLGA CBC

```{r effortPlots, fig.cap= "Annual effort and species richness for the FLGA CBC circle. Dashed line indicates year we begin analyses.", include=T, echo = F }
hours.p <- ggplot(data = birds)+
    geom_line(aes(year, hours))+
    xlim(c(min(birds$year), max(birds$year)))+
    theme_bw()+
    theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
    ylab("hours effort") +
    geom_vline(xintercept = startYear, linetype = 2, color = "red")
    
rich.p <- ggplot(data = birds %>% distinct(year, rich))+
    geom_line(aes(year, rich))+
    xlim(c(min(birds$year), max(birds$year)))+
    theme_bw() + 
    theme(plot.margin=grid::unit(c(0,0,0,0), "mm"))+
    ylab("# species")+
    geom_vline(xintercept = startYear, linetype = 2, color = "red")
    

gridExtra::grid.arrange(rich.p, hours.p)
```

The count format (broken up into 11 teams and all day counts) was instituted in 1972, so i think that would be a good time to begin. Therefore, we analze data from `r paste(startYear)` to `r paste(max(birds$year))`.


## Species groups
```{r sppGroupTab}
# Get species groupings
sppGroups <- speciesGroups() 

sppGroups <- stack(setNames(sppGroups, names(sppGroups)))  %>% 
    distinct(values, ind) %>%
    rename(species = values, 
           sppGroup = ind) %>% 
    mutate(index = "X") %>% 
    spread( key  = "sppGroup" , value = "index" ,  fill = " ")

sppGroups %>%
  kable( format    = "latex", 
      longtable = T, 
      booktabs  = T, 
      caption   = "Species groups for analysis") %>% 
    kable_styling()
```

